import streamlit as st
import pandas as pd
from openai import OpenAI
import os

# 1. ç½‘é¡µé…ç½®
st.set_page_config(page_title="æ”¿æ²»è€å¸ˆAIåŠ©æ‰‹", layout="wide")
st.title("ğŸ“– æ”¿æ²»ç´ ææ™ºèƒ½åŒ¹é…ç³»ç»Ÿ")

# 2. ä¾§è¾¹æ é…ç½®
with st.sidebar:
    st.header("âš™ï¸ è®¾ç½®")
    api_key = st.text_input("è¾“å…¥ API Key", type="password")
    base_url = st.text_input("APIåœ°å€ (é»˜è®¤DeepSeek)", value="https://api.deepseek.com")

# 3. åŠ è½½æ•™æ
@st.cache_data
def load_data():
    if os.path.exists('textbook.csv'):
        return pd.read_csv('textbook.csv')
    return None

df = load_data()

# 4. ç•Œé¢åŠŸèƒ½
if df is not None:
    news_text = st.text_area("åœ¨æ­¤ç²˜è´´æ–°é—»ç´ æï¼š", height=200)
    if st.button("å¼€å§‹åˆ†æ"):
        if not api_key:
            st.error("è¯·å…ˆè¾“å…¥ API Key")
        else:
            client = OpenAI(api_key=api_key, base_url=base_url)
            with st.spinner('AI æ­£åœ¨ç¿»é˜…æ•™æ...'):
                prompt = f"ä½ æ˜¯æ”¿æ²»è€å¸ˆã€‚è¯·æ ¹æ®æ•™æå†…å®¹ï¼š\n{df.to_string()}\nåˆ†æè¿™åˆ™æ–°é—»ï¼š\n{news_text}"
                response = client.chat.completions.create(
                    model="deepseek-chat",
                    messages=[{"role": "user", "content": prompt}]
                )
                st.write("### ğŸ“ å…³è”åˆ†æç»“æœï¼š")
                st.markdown(response.choices[0].message.content)
else:
    st.error("æœªæ‰¾åˆ° textbook.csv æ–‡ä»¶ï¼Œè¯·ç¡®ä¿å®ƒåœ¨ GitHub ä»“åº“ä¸­ã€‚")
