import streamlit as st
import pandas as pd
from openai import OpenAI

# --- 1. åŸºç¡€é…ç½® ---
st.set_page_config(page_title="æ”¿æ²»æ•™å¸ˆAIåŠ©æ‰‹", layout="wide")
st.title("ğŸ“– é«˜ä¸­æ”¿æ²»æ—¶æ”¿ç´ æè‡ªåŠ¨å…³è”ç³»ç»Ÿ")

# --- 2. ä¾§è¾¹æ é…ç½®ï¼šè¾“å…¥ä½ çš„ API Key ---
st.sidebar.header("è®¾ç½®")
api_key = st.sidebar.text_input("è¾“å…¥ä½ çš„ API Key", type="password")
model_choice = "deepseek-chat" # æˆ–è€…ä½¿ç”¨ "glm-4"

# --- 3. è¯»å–ä½ åˆšåšå¥½çš„ CSV è¡¨æ ¼ ---
@st.cache_data
def load_data():
    # è¯»å–ä½ æ•´ç†çš„æ•™æ
    return pd.read_csv('textbook.csv')

try:
    df = load_data()
    st.sidebar.success(f"æˆåŠŸåŠ è½½æ•™æï¼šå·²è¯†åˆ« {len(df)} æ¡çŸ¥è¯†ç‚¹")
except:
    st.sidebar.error("æ‰¾ä¸åˆ° textbook.csvï¼Œè¯·ç¡®ä¿å®ƒå’Œæœ¬ç¨‹åºåœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸‹")

# --- 4. æ ¸å¿ƒåŠŸèƒ½ï¼šè¾“å…¥æ–°é—»å¹¶åˆ†æ ---
st.subheader("ç¬¬ä¸€æ­¥ï¼šç²˜è´´æ—¶æ”¿ç´ æ")
news_text = st.text_area("åœ¨æ­¤ç²˜è´´çƒ­ç‚¹æ–°é—»æˆ–æ—¶æ”¿æ¡ˆä¾‹ï¼š", height=200, placeholder="ä¾‹å¦‚ï¼šæ–°è´¨ç”Ÿäº§åŠ›çš„å‘å±•æå‡äº†æˆ‘å›½æ ¸å¿ƒç«äº‰åŠ›...")

if st.button("ğŸš€ å¼€å§‹æ™ºèƒ½å…³è”"):
    if not api_key:
        st.warning("è¯·å…ˆåœ¨å·¦è¾¹è¾“å…¥ API Key æ‰èƒ½è¿è¡Œå“¦ï¼")
    elif not news_text:
        st.warning("è¯·å…ˆç²˜è´´ä¸€æ®µæ–°é—»å†…å®¹ã€‚")
    else:
        # åˆå§‹åŒ– AI
        client = OpenAI(api_key=api_key, base_url="https://api.deepseek.com") # å¦‚æœç”¨æ™ºè°±ï¼ŒURLè¦æ”¹

        with st.spinner('AI æ­£åœ¨ç¿»é˜…æ•™æè¿›è¡Œæ·±åº¦åŒ¹é…...'):
            # å°†ä½ çš„æ•™æå†…å®¹è½¬ä¸ºæ–‡æœ¬ï¼Œå‘ç»™ AI
            textbook_context = df.to_string(index=False)
            
            prompt = f"""
            ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é«˜ä¸­æ”¿æ²»æ•™ç ”å‘˜ã€‚
            ä»»åŠ¡ï¼šè¯·ä»ä¸‹æ–¹çš„ã€æ•™æçŸ¥è¯†åº“ã€‘ä¸­ï¼Œæ‰¾å‡ºä¸ã€æ—¶æ”¿ç´ æã€‘æœ€åŒ¹é…çš„ 1-3 ä¸ªçŸ¥è¯†ç‚¹ã€‚
            
            ã€æ•™æçŸ¥è¯†åº“ã€‘ï¼š
            {textbook_context}
            
            ã€æ—¶æ”¿ç´ æã€‘ï¼š
            {news_text}
            
            è¯·æŒ‰æ­¤æ ¼å¼å›å¤ï¼š
            ### ğŸ“ å…³è”çŸ¥è¯†ç‚¹ 1
            - **æ ¸å¿ƒè€ƒç‚¹**ï¼š(å¡«æ•™æé‡Œçš„è€ƒç‚¹åç§°)
            - **æ•™æåŸè¯**ï¼š(å¡«æ•™æé‡Œçš„åŸç†å†…å®¹)
            - **ç»“åˆç‚¹åˆ†æ**ï¼š(ç”¨åŸç†åˆ†ææ–°é—»ï¼Œè§£é‡Šä¸ºä»€ä¹ˆè¦ç”¨è¿™ä¸ªç‚¹ï¼Œ100å­—ä»¥å†…)
            """

            response = client.chat.completions.create(
                model=model_choice,
                messages=[{"role": "user", "content": prompt}]
            )
            
            st.markdown("---")
            st.subheader("ç¬¬äºŒæ­¥ï¼šAI å…³è”åˆ†æç»“æœ")
            st.markdown(response.choices[0].message.content)

# --- 5. é¡µè„šæç¤º ---
st.caption("æç¤ºï¼šæœ¬å·¥å…·ä»…ä¾›æ•™å¸ˆå¤‡è¯¾å‚è€ƒï¼Œå»ºè®®ç»“åˆæœ€æ–°æ•™å‚ä½¿ç”¨ã€‚")